<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev3.nms.mapper.PortMapper">

    <resultMap id="PortResultMap" type="dev3.nms.vo.mgmt.PortVO">
        <id property="DEVICE_ID" column="DEVICE_ID"/>
        <id property="IF_INDEX" column="IF_INDEX"/>
        <result property="IF_DESCR" column="IF_DESCR"/>
        <result property="IF_NAME" column="IF_NAME"/>
        <result property="IF_DESCRIPTION" column="IF_DESCRIPTION"/>
        <result property="IF_TYPE" column="IF_TYPE"/>
        <result property="IF_TYPE_NAME" column="IF_TYPE_NAME"/>
        <result property="IF_MTU" column="IF_MTU"/>
        <result property="IF_SPEED" column="IF_SPEED"/>
        <result property="IF_HIGH_SPEED" column="IF_HIGH_SPEED"/>
        <result property="IF_MAC_ADDRESS" column="IF_MAC_ADDRESS"/>
        <result property="IF_ADMIN_STATUS" column="IF_ADMIN_STATUS"/>
        <result property="IF_OPER_STATUS" column="IF_OPER_STATUS"/>
        <result property="IF_LAST_CHANGE" column="IF_LAST_CHANGE"/>
        <result property="IF_IP_ADDRESS" column="IF_IP_ADDRESS"/>
        <result property="IF_IP_NETMASK" column="IF_IP_NETMASK"/>
        <result property="IF_PERF_FLAG" column="IF_PERF_FLAG"/>
        <result property="IF_OPER_FLAG" column="IF_OPER_FLAG"/>
        <result property="IF_CHART_FLAG" column="IF_CHART_FLAG"/>
        <result property="DEVICE_NAME" column="DEVICE_NAME"/>
        <result property="DEVICE_IP" column="DEVICE_IP"/>
        <result property="DELETE_AT" column="DELETE_AT"/>
    </resultMap>

    <!-- 특정 장비의 Ethernet 포트 조회 (IF_TYPE = 6) -->
    <select id="findByDeviceId" resultMap="PortResultMap">
        SELECT
            p.*,
            d.DEVICE_NAME,
            d.DEVICE_IP,
            t.IF_TYPE_NAME
        FROM r_port_t p
        LEFT JOIN r_device_t d ON p.DEVICE_ID = d.DEVICE_ID
        LEFT JOIN r_if_type_t t ON p.IF_TYPE = t.IF_TYPE
        WHERE p.DEVICE_ID = #{deviceId}
          AND p.IF_TYPE = 6
          AND p.DELETE_AT IS NULL
        ORDER BY p.IF_INDEX
    </select>

    <!-- 특정 포트 조회 -->
    <select id="findByDeviceIdAndIfIndex" resultMap="PortResultMap">
        SELECT
            p.*,
            d.DEVICE_NAME,
            d.DEVICE_IP,
            t.IF_TYPE_NAME
        FROM r_port_t p
        LEFT JOIN r_device_t d ON p.DEVICE_ID = d.DEVICE_ID
        LEFT JOIN r_if_type_t t ON p.IF_TYPE = t.IF_TYPE
        WHERE p.DEVICE_ID = #{deviceId}
          AND p.IF_INDEX = #{ifIndex}
          AND p.DELETE_AT IS NULL
    </select>

    <!-- 모든 포트 조회 -->
    <select id="findAll" resultMap="PortResultMap">
        SELECT
            p.*,
            d.DEVICE_NAME,
            d.DEVICE_IP,
            t.IF_TYPE_NAME
        FROM r_port_t p
        LEFT JOIN r_device_t d ON p.DEVICE_ID = d.DEVICE_ID
        LEFT JOIN r_if_type_t t ON p.IF_TYPE = t.IF_TYPE
        WHERE p.DELETE_AT IS NULL
          AND d.DELETE_AT IS NULL
        ORDER BY p.DEVICE_ID, p.IF_INDEX
    </select>

    <!-- 감시 대상 포트만 조회 -->
    <select id="findMonitoredPorts" resultMap="PortResultMap">
        SELECT
            p.*,
            d.DEVICE_NAME,
            d.DEVICE_IP,
            t.IF_TYPE_NAME
        FROM r_port_t p
        LEFT JOIN r_device_t d ON p.DEVICE_ID = d.DEVICE_ID
        LEFT JOIN r_if_type_t t ON p.IF_TYPE = t.IF_TYPE
        WHERE (p.IF_PERF_FLAG = TRUE OR p.IF_OPER_FLAG = TRUE)
          AND p.DELETE_AT IS NULL
          AND d.DELETE_AT IS NULL
        ORDER BY p.DEVICE_ID, p.IF_INDEX
    </select>

    <!-- 포트 등록 (ADMIN/OPER STATUS는 기본값 1) -->
    <insert id="insertPort" parameterType="dev3.nms.vo.mgmt.PortVO">
        INSERT INTO r_port_t (
            DEVICE_ID, IF_INDEX, IF_DESCR, IF_NAME, IF_DESCRIPTION, IF_TYPE, IF_MTU,
            IF_SPEED, IF_HIGH_SPEED, IF_MAC_ADDRESS, IF_ADMIN_STATUS, IF_OPER_STATUS,
            IF_LAST_CHANGE, IF_IP_ADDRESS, IF_IP_NETMASK
        ) VALUES (
            #{DEVICE_ID}, #{IF_INDEX}, #{IF_DESCR}, #{IF_NAME}, #{IF_DESCRIPTION}, #{IF_TYPE}, #{IF_MTU},
            #{IF_SPEED}, #{IF_HIGH_SPEED}, #{IF_MAC_ADDRESS}, 1, 1,
            #{IF_LAST_CHANGE}, #{IF_IP_ADDRESS}, #{IF_IP_NETMASK}
        )
    </insert>

    <!-- 포트 일괄 등록 (ADMIN/OPER STATUS는 기본값 1) -->
    <insert id="insertPorts" parameterType="java.util.List">
        INSERT INTO r_port_t (
            DEVICE_ID, IF_INDEX, IF_DESCR, IF_NAME, IF_DESCRIPTION, IF_TYPE, IF_MTU,
            IF_SPEED, IF_HIGH_SPEED, IF_MAC_ADDRESS, IF_ADMIN_STATUS, IF_OPER_STATUS,
            IF_LAST_CHANGE, IF_IP_ADDRESS, IF_IP_NETMASK
        ) VALUES
        <foreach collection="list" item="port" separator=",">
            (
            #{port.DEVICE_ID}, #{port.IF_INDEX}, #{port.IF_DESCR}, #{port.IF_NAME}, #{port.IF_DESCRIPTION},
            #{port.IF_TYPE}, #{port.IF_MTU}, #{port.IF_SPEED}, #{port.IF_HIGH_SPEED}, #{port.IF_MAC_ADDRESS},
            1, 1, #{port.IF_LAST_CHANGE},
            #{port.IF_IP_ADDRESS}, #{port.IF_IP_NETMASK}
            )
        </foreach>
    </insert>

    <!-- 포트 정보 수정 -->
    <update id="updatePort" parameterType="dev3.nms.vo.mgmt.PortVO">
        UPDATE r_port_t
        <set>
            <if test="IF_DESCR != null">IF_DESCR = #{IF_DESCR},</if>
            <if test="IF_NAME != null">IF_NAME = #{IF_NAME},</if>
            <if test="IF_DESCRIPTION != null">IF_DESCRIPTION = #{IF_DESCRIPTION},</if>
            <if test="IF_TYPE != null">IF_TYPE = #{IF_TYPE},</if>
            <if test="IF_MTU != null">IF_MTU = #{IF_MTU},</if>
            <if test="IF_SPEED != null">IF_SPEED = #{IF_SPEED},</if>
            <if test="IF_HIGH_SPEED != null">IF_HIGH_SPEED = #{IF_HIGH_SPEED},</if>
            <if test="IF_MAC_ADDRESS != null">IF_MAC_ADDRESS = #{IF_MAC_ADDRESS},</if>
            <if test="IF_ADMIN_STATUS != null">IF_ADMIN_STATUS = #{IF_ADMIN_STATUS},</if>
            <if test="IF_OPER_STATUS != null">IF_OPER_STATUS = #{IF_OPER_STATUS},</if>
            <if test="IF_LAST_CHANGE != null">IF_LAST_CHANGE = #{IF_LAST_CHANGE},</if>
            <if test="IF_IP_ADDRESS != null">IF_IP_ADDRESS = #{IF_IP_ADDRESS},</if>
            <if test="IF_IP_NETMASK != null">IF_IP_NETMASK = #{IF_IP_NETMASK},</if>
            <if test="IF_PERF_FLAG != null">IF_PERF_FLAG = #{IF_PERF_FLAG},</if>
            <if test="IF_OPER_FLAG != null">IF_OPER_FLAG = #{IF_OPER_FLAG},</if>
            <if test="IF_CHART_FLAG != null">IF_CHART_FLAG = #{IF_CHART_FLAG},</if>
        </set>
        WHERE DEVICE_ID = #{DEVICE_ID} AND IF_INDEX = #{IF_INDEX}
    </update>

    <!-- 포트 감시 설정 수정 -->
    <update id="updateMonitorSettings">
        UPDATE r_port_t
        SET IF_OPER_FLAG = #{ifOperFlag},
            IF_PERF_FLAG = #{ifPerfFlag}
        WHERE DEVICE_ID = #{deviceId} AND IF_INDEX = #{ifIndex}
    </update>

    <!-- 포트 삭제 (소프트 삭제) -->
    <update id="deletePort">
        UPDATE r_port_t
        SET DELETE_AT = NOW()
        WHERE DEVICE_ID = #{deviceId} AND IF_INDEX = #{ifIndex}
    </update>

    <!-- 장비의 모든 포트 삭제 (소프트 삭제) -->
    <update id="deletePortsByDeviceId">
        UPDATE r_port_t
        SET DELETE_AT = NOW()
        WHERE DEVICE_ID = #{deviceId}
    </update>

    <!-- 특정 장비의 포트 개수 조회 -->
    <select id="countByDeviceId" resultType="int">
        SELECT COUNT(*) FROM r_port_t
        WHERE DEVICE_ID = #{deviceId} AND DELETE_AT IS NULL
    </select>

    <!-- 차트 플래그 토글 -->
    <update id="updateChartFlag">
        UPDATE r_port_t
        SET IF_CHART_FLAG = #{chartFlag}
        WHERE DEVICE_ID = #{deviceId} AND IF_INDEX = #{ifIndex}
    </update>

    <!-- 장비의 차트 표시 포트 조회 -->
    <select id="findChartEnabledPorts" resultMap="PortResultMap">
        SELECT
            p.*,
            d.DEVICE_NAME,
            d.DEVICE_IP,
            t.IF_TYPE_NAME
        FROM r_port_t p
        LEFT JOIN r_device_t d ON p.DEVICE_ID = d.DEVICE_ID
        LEFT JOIN r_if_type_t t ON p.IF_TYPE = t.IF_TYPE
        WHERE p.DEVICE_ID = #{deviceId}
          AND p.IF_CHART_FLAG = 1
          AND p.DELETE_AT IS NULL
        ORDER BY p.IF_INDEX
    </select>

    <!-- 장비의 차트 표시 포트 수 조회 -->
    <select id="countChartEnabledPorts" resultType="int">
        SELECT COUNT(*) FROM r_port_t
        WHERE DEVICE_ID = #{deviceId}
          AND IF_CHART_FLAG = 1
          AND DELETE_AT IS NULL
    </select>

    <!-- 장비의 모든 포트 차트 플래그 초기화 -->
    <update id="resetChartFlags">
        UPDATE r_port_t
        SET IF_CHART_FLAG = 0
        WHERE DEVICE_ID = #{deviceId}
    </update>

    <!-- TOP N 트래픽 포트에 차트 플래그 설정 (MariaDB 호환 - JOIN 사용) -->
    <update id="setTopTrafficPortsChartFlag">
        UPDATE r_port_t p
        INNER JOIN (
            SELECT t.IF_INDEX
            FROM p_traffic_t t
            WHERE t.DEVICE_ID = #{deviceId}
              AND t.COLLECTED_AT >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
            GROUP BY t.IF_INDEX
            ORDER BY AVG(COALESCE(t.IN_BPS, 0) + COALESCE(t.OUT_BPS, 0)) DESC
            LIMIT #{limit}
        ) top_ports ON p.IF_INDEX = top_ports.IF_INDEX
        SET p.IF_CHART_FLAG = 1
        WHERE p.DEVICE_ID = #{deviceId}
          AND p.DELETE_AT IS NULL
    </update>

</mapper>
