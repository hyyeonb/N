<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dev3.nms.mapper.UserMapper">

    <resultMap id="UserResultMap" type="dev3.nms.vo.auth.UserVO">
        <id property="USER_ID" column="USER_ID"/>
        <result property="LOGIN_ID" column="LOGIN_ID"/>
        <result property="PASSWORD" column="PASSWORD"/>
        <result property="EMAIL" column="EMAIL"/>
        <result property="NAME" column="NAME"/>
        <result property="PHONE" column="PHONE"/>
        <result property="PROFILE_IMAGE" column="PROFILE_IMAGE"/>
        <result property="SOCIAL_TYPE" column="SOCIAL_TYPE"/>
        <result property="SOCIAL_ID" column="SOCIAL_ID"/>
        <result property="CREATED_AT" column="CREATED_AT"/>
        <result property="UPDATED_AT" column="UPDATED_AT"/>
    </resultMap>

    <!-- 소셜 타입과 소셜 ID로 사용자 조회 -->
    <select id="findBySocialTypeAndSocialId" resultMap="UserResultMap">
        SELECT *
        FROM USER
        WHERE SOCIAL_TYPE = #{SOCIAL_TYPE}
          AND SOCIAL_ID = #{SOCIAL_ID}
    </select>

    <!-- 이메일로 사용자 조회 (NULL 이메일은 조회하지 않음) -->
    <select id="findByEmail" resultMap="UserResultMap">
        SELECT *
        FROM USER
        WHERE EMAIL = #{EMAIL}
          AND EMAIL IS NOT NULL
          AND EMAIL != ''
    </select>

    <!-- 사용자 ID로 조회 -->
    <select id="findById" resultMap="UserResultMap">
        SELECT *
        FROM USER
        WHERE USER_ID = #{USER_ID}
    </select>

    <!-- 새 사용자 생성 (소셜 로그인) - 빈 문자열 EMAIL은 NULL로 변환 -->
    <insert id="insert" parameterType="dev3.nms.vo.auth.UserVO"
            useGeneratedKeys="true" keyProperty="USER_ID" keyColumn="USER_ID">
        INSERT INTO USER (EMAIL, NAME, PROFILE_IMAGE, SOCIAL_TYPE, SOCIAL_ID)
        VALUES (NULLIF(#{EMAIL}, ''), #{NAME}, #{PROFILE_IMAGE}, #{SOCIAL_TYPE}, #{SOCIAL_ID})
    </insert>

    <!-- 새 사용자 생성 (로컬 회원가입) - 빈 문자열 EMAIL은 NULL로 변환 -->
    <insert id="insertLocal" parameterType="dev3.nms.vo.auth.UserVO"
            useGeneratedKeys="true" keyProperty="USER_ID" keyColumn="USER_ID">
        INSERT INTO USER (LOGIN_ID, PASSWORD, EMAIL, NAME, PHONE, SOCIAL_TYPE)
        VALUES (#{LOGIN_ID}, #{PASSWORD}, NULLIF(#{EMAIL}, ''), #{NAME}, #{PHONE}, 'LOCAL')
    </insert>

    <!-- 로그인 ID로 사용자 조회 -->
    <select id="findByLoginId" resultMap="UserResultMap">
        SELECT *
        FROM USER
        WHERE LOGIN_ID = #{LOGIN_ID}
    </select>

    <!-- 사용자 정보 업데이트 -->
    <update id="update" parameterType="dev3.nms.vo.auth.UserVO">
        UPDATE USER
        SET EMAIL = #{EMAIL},
            NAME = #{NAME},
            PROFILE_IMAGE = #{PROFILE_IMAGE}
        WHERE USER_ID = #{USER_ID}
    </update>

    <!-- 전화번호로 사용자 조회 (전화번호 중복 체크) -->
    <select id="findByPhone" resultMap="UserResultMap">
        SELECT *
        FROM USER
        WHERE PHONE = #{PHONE}
          AND PHONE IS NOT NULL
          AND PHONE != ''
          AND SOCIAL_TYPE = 'LOCAL'
    </select>

    <!-- 이름과 전화번호로 사용자 조회 (아이디 찾기) -->
    <select id="findByNameAndPhone" resultMap="UserResultMap">
        SELECT *
        FROM USER
        WHERE NAME = #{NAME}
          AND PHONE = #{PHONE}
          AND SOCIAL_TYPE = 'LOCAL'
    </select>

    <!-- 로그인 ID, 이름, 전화번호로 사용자 조회 (비밀번호 재설정 검증) -->
    <select id="findByLoginIdAndNameAndPhone" resultMap="UserResultMap">
        SELECT *
        FROM USER
        WHERE LOGIN_ID = #{LOGIN_ID}
          AND NAME = #{NAME}
          AND PHONE = #{PHONE}
          AND SOCIAL_TYPE = 'LOCAL'
    </select>

    <!-- 비밀번호 변경 -->
    <update id="updatePassword">
        UPDATE USER
        SET PASSWORD = #{PASSWORD},
            UPDATED_AT = NOW()
        WHERE USER_ID = #{USER_ID}
    </update>

</mapper>
