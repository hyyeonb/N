<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev3.nms.mapper.TrafficMapper">

    <resultMap id="TrafficResultMap" type="dev3.nms.vo.mgmt.TrafficVO">
        <id property="DEVICE_ID" column="DEVICE_ID"/>
        <id property="IF_INDEX" column="IF_INDEX"/>
        <id property="COLLECTED_AT" column="COLLECTED_AT"/>
        <result property="IN_OCTET" column="IN_OCTET"/>
        <result property="IN_HIGH_OCTET" column="IN_HIGH_OCTET"/>
        <result property="OUT_OCTET" column="OUT_OCTET"/>
        <result property="OUT_HIGH_OCTET" column="OUT_HIGH_OCTET"/>
        <result property="IN_DISCARD" column="IN_DISCARD"/>
        <result property="IN_ERROR" column="IN_ERROR"/>
        <result property="OUT_DISCARD" column="OUT_DISCARD"/>
        <result property="OUT_ERROR" column="OUT_ERROR"/>
        <result property="IN_USED" column="IN_USED"/>
        <result property="IN_HIGH_USED" column="IN_HIGH_USED"/>
        <result property="OUT_USED" column="OUT_USED"/>
        <result property="OUT_HIGH_USED" column="OUT_HIGH_USED"/>
        <result property="IN_DISCARD_USED" column="IN_DISCARD_USED"/>
        <result property="IN_ERROR_USED" column="IN_ERROR_USED"/>
        <result property="OUT_DISCARD_USED" column="OUT_DISCARD_USED"/>
        <result property="OUT_ERROR_USED" column="OUT_ERROR_USED"/>
        <result property="IN_BPS" column="IN_BPS"/>
        <result property="IN_HIGH_BPS" column="IN_HIGH_BPS"/>
        <result property="OUT_BPS" column="OUT_BPS"/>
        <result property="OUT_HIGH_BPS" column="OUT_HIGH_BPS"/>
        <result property="IF_NAME" column="IF_NAME"/>
        <result property="IF_DESCR" column="IF_DESCR"/>
    </resultMap>

    <!-- 특정 장비의 최근 트래픽 데이터 조회 (UP 포트만) -->
    <select id="findRecentByDeviceId" resultMap="TrafficResultMap">
        SELECT
            t.*,
            p.IF_NAME,
            p.IF_DESCR
        FROM P_TRAFFIC_T t
        INNER JOIN r_port_t p ON t.DEVICE_ID = p.DEVICE_ID AND t.IF_INDEX = p.IF_INDEX
        WHERE t.DEVICE_ID = #{deviceId}
          AND t.COLLECTED_AT >= DATE_SUB(NOW(), INTERVAL #{minutes} MINUTE)
          AND p.IF_OPER_STATUS = 1
          AND p.DELETE_AT IS NULL
        ORDER BY t.IF_INDEX, t.COLLECTED_AT ASC
    </select>

    <!-- 특정 장비/포트의 최근 트래픽 데이터 조회 -->
    <select id="findRecentByDeviceIdAndIfIndex" resultMap="TrafficResultMap">
        SELECT
            t.*,
            p.IF_NAME,
            p.IF_DESCR
        FROM P_TRAFFIC_T t
        LEFT JOIN r_port_t p ON t.DEVICE_ID = p.DEVICE_ID AND t.IF_INDEX = p.IF_INDEX
        WHERE t.DEVICE_ID = #{deviceId}
          AND t.IF_INDEX = #{ifIndex}
          AND t.COLLECTED_AT >= DATE_SUB(NOW(), INTERVAL #{minutes} MINUTE)
        ORDER BY t.COLLECTED_AT ASC
    </select>

    <!-- 특정 장비의 트래픽 데이터 조회 (시간 범위) -->
    <select id="findByDeviceIdAndTimeRange" resultMap="TrafficResultMap">
        SELECT
            t.*,
            p.IF_NAME,
            p.IF_DESCR
        FROM P_TRAFFIC_T t
        LEFT JOIN r_port_t p ON t.DEVICE_ID = p.DEVICE_ID AND t.IF_INDEX = p.IF_INDEX
        WHERE t.DEVICE_ID = #{deviceId}
          AND t.COLLECTED_AT BETWEEN #{startTime} AND #{endTime}
        ORDER BY t.IF_INDEX, t.COLLECTED_AT ASC
    </select>

    <!-- 특정 장비의 최신 트래픽 데이터 1건 조회 (포트별) -->
    <select id="findLatestByDeviceId" resultMap="TrafficResultMap">
        SELECT
            t.*,
            p.IF_NAME,
            p.IF_DESCR
        FROM P_TRAFFIC_T t
        INNER JOIN (
            SELECT DEVICE_ID, IF_INDEX, MAX(COLLECTED_AT) as MAX_TIME
            FROM P_TRAFFIC_T
            WHERE DEVICE_ID = #{deviceId}
            GROUP BY DEVICE_ID, IF_INDEX
        ) latest ON t.DEVICE_ID = latest.DEVICE_ID
                 AND t.IF_INDEX = latest.IF_INDEX
                 AND t.COLLECTED_AT = latest.MAX_TIME
        LEFT JOIN r_port_t p ON t.DEVICE_ID = p.DEVICE_ID AND t.IF_INDEX = p.IF_INDEX
        ORDER BY t.IF_INDEX
    </select>

</mapper>
